{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h3 class="fw-bold section-heading">Jobs</h3>
    <div class="table-responsive shadow-sm rounded">
        <table class="table align-middle mb-0" id="jobsTable">
            <thead class="table-header-custom">
            <tr>
                <th>Job ID</th>
                <th>Title</th>
                <th>Category</th>
                <th>Description</th>
                <th>Created By</th>
                <th>Job Date</th>
                <th>Status</th>
                <th>Assigned Technician</th>
            </tr>
            </thead>
            <tbody>
            {% for job in jobs %}
            <tr>
                <td>
                    <a href="{{ url_for('job_details', job_id=job.job_id) }}"
                       class="text-decoration-none fw-semibold text-accent">
                        {{ job.job_id[:6] }}..
                    </a>
                </td>
                <td>{{ job.title }}</td>
                <td><span class="badge bg-accent">{{ job.job_category }}</span></td>
                <td>{{ job.description }}</td>
                <td>{{ job.created_by }}</td>
                <td>{{ job.job_date }}</td>
                <td>
                        <span class="badge
                            {% if job.status == 'Pending' %}status-pending
                            {% elif job.status == 'Assigned' %}status-assigned
                            {% elif job.status == 'Completed' %}status-completed
                            {% else %}status-default{% endif %}">
                            {{ job.status }}
                        </span>
                </td>
                <td>
                    {% if current_user.role == 'Admin' %}
                    <form method="POST" action="{{ url_for('reassign_technician') }}">
                        <input type="hidden" name="job_id" value="{{ job.job_id }}">
                        <select name="assigned_to" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="">Select Technician</option>
                            {% for tech in available_technicians %}
                            <option value="{{ tech.id }}"
                                    {% if job.assigned_to and tech.id== job.assigned_to.id %}selected{% endif %}>
                                {{ tech.name }} ({{ tech.status_label }})
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                    {% else %}
                    {{ job.assigned_to.name if job.assigned_to else 'Unassigned' }}
                    {% endif %}
                </td>
            </tr>
            {% if job.status == 'Pending' and not job.assigned_to and job.suggestions %}
            <tr class="suggestions-row">
                <td colspan="8" class="bg-light p-3 border-start border-end border-bottom">
                    <strong class="text-dark">AI Technician Suggestions:</strong>
                    <ul class="list-unstyled mt-2 mb-0">
                        {% for s in job.suggestions %}
                        <li class="d-flex align-items-center mb-2">
                            <div>
                                <span class="fw-semibold">{{ s.technician_name }}</span> -
                                Score: <strong>{{ s.score }}</strong> |
                                Active Jobs: {{ s.active_jobs }} |
                                Skills: <em>{{ s.skills | join(", ") }}</em>
                            </div>
                            <form method="POST" action="{{ url_for('reassign_technician') }}" class="ms-auto">
                                <input type="hidden" name="job_id" value="{{ job.job_id }}">
                                <input type="hidden" name="assigned_to" value="{{ s.technician_id }}">
                                <button type="submit" class="btn btn-sm btn-dark-gradient">Assign</button>
                            </form>

                        </li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="pagination" class="mt-4 d-flex justify-content-center"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rowsPerPage = 5;
        const tbody = document.getElementById("jobsTable").querySelector("tbody");
        const allRows = Array.from(tbody.querySelectorAll("tr"));
        const pagination = document.getElementById("pagination");

        // Group rows with suggestions
        let groupedRows = [];
        for (let i = 0; i < allRows.length; i++) {
            let group = [allRows[i]];
            if (allRows[i + 1] && allRows[i + 1].classList.contains("suggestions-row")) {
                group.push(allRows[i + 1]);
                i++;
            }
            groupedRows.push(group);
        }

        const totalPages = Math.ceil(groupedRows.length / rowsPerPage);
        let currentPage = 1;

        function displayPage(page) {
            currentPage = page;
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            groupedRows.forEach((group, index) => {
                group.forEach(row => row.style.display = (index >= start && index < end) ? "" : "none");
            });
            renderPagination();
        }

        function renderPagination() {
            pagination.innerHTML = "";
            const ul = document.createElement("ul");
            ul.className = "pagination";
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement("li");
                li.className = `page-item ${i === currentPage ? "active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener("click", e => {
                    e.preventDefault();
                    displayPage(i);
                });
                ul.appendChild(li);
            }
            pagination.appendChild(ul);
        }

        displayPage(1);
    });
</script>
{% endblock %}